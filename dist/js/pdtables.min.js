/*!
 * PdTables v2.0 - API Integrated Virtual Table
 * Callback pattern - Flexible UI integration
 * (c) 2025 - License: MIT
 */
class PdTables{constructor(t,e,a={}){this.table="string"==typeof t?document.querySelector(t):t,this.id="pdt_"+Date.now(),this.data=Array.isArray(e)?e:[],this.filtered=[...this.data],this.config={height:400,rowHeight:42,visibleRows:25,virtualScroll:!0,searchable:!0,selectable:!1,striped:!1,hover:!0,api:null,autoLoad:!1,columns:[],...a},this.callbacks={onAddClick:a.onAddClick||(()=>{}),onEditClick:a.onEditClick||(()=>{}),onDeleteClick:a.onDeleteClick||(()=>{}),onSuccess:a.onSuccess||(()=>{}),onError:a.onError||(t=>console.error(t)),onLoad:a.onLoad||(()=>{}),...a.callbacks},this.state={scrollTop:0,searchText:"",selected:new Set,searchTimeout:null,loading:!1},this.dom={},this.init()}async init(){this.injectCSS(),this.createWrapper(),this.createControls(),this.createBody(),this.attachEvents(),this.config.autoLoad&&this.config.api?.load?await this.loadData():this.render()}injectCSS(){if(document.getElementById("pd-tables-css"))return;const t=document.createElement("style");t.id="pd-tables-css",t.textContent=".pd-wrap{border:1px solid #e2e8f0;border-radius:6px;background:#fff;font-family:system-ui,sans-serif;overflow:auto;position:relative}.pd-ctrl{padding:12px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;gap:10px;flex-wrap:wrap}.pd-search{flex:1;min-width:200px;padding:8px 12px;border:1px solid #cbd5e0;border-radius:4px}.pd-btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:opacity .2s}.pd-btn:hover{opacity:.8}.pd-btn:disabled{opacity:.5;cursor:not-allowed}.pd-btn-add{background:#4299e1;color:#fff}.pd-btn-copy{background:#48bb78;color:#fff}.pd-btn-export{background:#9f7aea;color:#fff}.pd-count{background:#718096;color:#fff;padding:4px 10px;border-radius:12px;font-size:12px;margin-left:auto;display:none}.pd-table{width:100%;border-collapse:collapse}.pd-table th{background:#edf2f7;padding:12px;text-align:left;font-weight:600;position:sticky;top:0;z-index:1}.pd-table td{padding:12px;border-bottom:1px solid #e2e8f0}.pd-table input[type=checkbox]{cursor:pointer}.pd-act{padding:4px 8px;font-size:12px;margin:2px;border-radius:3px;border:none;cursor:pointer;transition:opacity .2s}.pd-act:hover{opacity:.8}.pd-edit{background:#fbbf24;color:#000}.pd-del{background:#f56565;color:#fff}.pd-loading{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:100}.pd-spinner{width:40px;height:40px;border:4px solid #e2e8f0;border-top-color:#4299e1;border-radius:50%;animation:pdSpin 1s linear infinite}.pd-striped tbody tr:nth-child(even){background:#fafafa}.pd-hover tbody tr:hover{background:#ebf8ff}@keyframes pdSpin{to{transform:rotate(360deg)}}",document.head.appendChild(t)}createWrapper(){this.dom.wrapper=document.createElement("div"),this.dom.wrapper.className="pd-wrap",this.dom.wrapper.style.height=this.config.height+"px",this.table.parentNode.insertBefore(this.dom.wrapper,this.table),this.dom.wrapper.appendChild(this.table),this.table.className="pd-table"+(this.config.striped?" pd-striped":"")+(this.config.hover?" pd-hover":"")}createControls(){const t=document.createElement("div");t.className="pd-ctrl",this.config.searchable&&(this.dom.search=document.createElement("input"),this.dom.search.type="text",this.dom.search.className="pd-search",this.dom.search.placeholder="Search...",t.appendChild(this.dom.search));const e=document.createElement("button");if(e.className="pd-btn pd-btn-add",e.textContent="+ Add",e.dataset.action="add",t.appendChild(e),this.config.selectable){const e=document.createElement("button");e.className="pd-btn pd-btn-copy",e.innerHTML='<span style="font-family:monospace">⎘</span> Copy',e.dataset.action="copy",t.appendChild(e),this.dom.counter=document.createElement("span"),this.dom.counter.className="pd-count",t.appendChild(this.dom.counter)}const a=document.createElement("button");a.className="pd-btn pd-btn-export",a.textContent="↓ CSV",a.dataset.action="export",t.appendChild(a),this.dom.wrapper.insertBefore(t,this.table)}createBody(){if(this.table.tBodies.length||this.table.createTBody(),this.dom.tbody=this.table.tBodies[0],this.config.selectable&&this.table.tHead){const t=document.createElement("th");t.style.width="50px",t.innerHTML='<input type="checkbox" data-select="all">',this.table.tHead.rows[0].insertBefore(t,this.table.tHead.rows[0].firstChild)}}attachEvents(){this.config.virtualScroll&&this.dom.wrapper.addEventListener("scroll",()=>{this.scrollRAF||(this.scrollRAF=requestAnimationFrame(()=>{this.state.scrollTop=this.dom.wrapper.scrollTop,this.render(),this.scrollRAF=null}))}),this.config.searchable&&this.dom.search&&this.dom.search.addEventListener("input",t=>{clearTimeout(this.state.searchTimeout),this.state.searchTimeout=setTimeout(()=>{this.state.searchText=t.target.value.toLowerCase(),this.render()},300)}),this.dom.wrapper.addEventListener("click",t=>{const e=t.target;if("all"===e.dataset.select&&this.selectAll(e.checked),"row"===e.dataset.select){const t=e.dataset.id;e.checked?this.state.selected.add(t):this.state.selected.delete(t),this.updateUI()}const a=e.dataset.action||e.closest("[data-action]")?.dataset.action;if("add"===a&&this.handleAdd(),"copy"===a&&this.copySelected(),"export"===a&&this.exportCSV(),"edit"===a){const t=parseInt(e.dataset.idx),a=this.data[t];this.handleEdit(t,a)}if("delete"===a){const t=parseInt(e.dataset.idx),a=this.data[t];this.handleDelete(t,a)}})}render(){this.filterData();const t=this.config.virtualScroll?Math.floor(this.state.scrollTop/this.config.rowHeight):0,e=t+this.config.visibleRows,a=this.filtered.slice(t,e);this.renderRows(a,t),this.updateUI()}filterData(){this.state.searchText?this.filtered=this.data.filter(t=>Object.values(t).some(t=>String(t).toLowerCase().includes(this.state.searchText))):this.filtered=[...this.data]}renderRows(t,e){const a=document.createDocumentFragment();if(t.forEach((t,i)=>{const s=e+i,o=document.createElement("tr");if(this.config.selectable){const e=t.id||t[0]||s,a=document.createElement("td");a.innerHTML=`<input type="checkbox" data-select="row" data-id="${e}" ${this.state.selected.has(e)?"checked":""}>`,o.appendChild(a)}if(this.config.columns.length)this.config.columns.forEach(e=>{const a=document.createElement("td"),i=t[e.key];this.state.searchText?a.innerHTML=this.highlight(i,this.state.searchText):a.textContent=i,o.appendChild(a)});else{(Array.isArray(t)?t:Object.values(t)).forEach(t=>{const e=document.createElement("td");this.state.searchText?e.innerHTML=this.highlight(t,this.state.searchText):e.textContent=t,o.appendChild(e)})}const d=document.createElement("td");d.innerHTML=`\n                <button class="pd-act pd-edit" data-action="edit" data-idx="${s}">Edit</button>\n                <button class="pd-act pd-del" data-action="delete" data-idx="${s}">Del</button>\n            `,o.appendChild(d),a.appendChild(o)}),this.dom.tbody.innerHTML="",this.dom.tbody.appendChild(a),this.config.virtualScroll){const t=this.filtered.length*this.config.rowHeight;this.dom.tbody.style.transform=`translateY(${e*this.config.rowHeight}px)`,this.table.style.height=t+"px"}}highlight(t,e){if(!e)return t;const a=new RegExp(`(${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return String(t).replace(a,'<mark style="background:#fef3c7">$1</mark>')}selectAll(t){this.filtered.slice(Math.floor(this.state.scrollTop/this.config.rowHeight),Math.floor(this.state.scrollTop/this.config.rowHeight)+this.config.visibleRows).forEach(e=>{const a=e.id||e[0]||this.data.indexOf(e);t?this.state.selected.add(a):this.state.selected.delete(a)}),this.render()}updateUI(){if(this.config.selectable&&this.dom.counter){const t=this.state.selected.size;this.dom.counter.textContent=t?`${t} selected`:"",this.dom.counter.style.display=t?"block":"none";const e=this.table.querySelector('[data-select="all"]');if(e){const t=this.dom.tbody.querySelectorAll('[data-select="row"]'),a=this.dom.tbody.querySelectorAll('[data-select="row"]:checked').length;e.checked=t.length>0&&a===t.length,e.indeterminate=a>0&&a<t.length}}}copySelected(){const t=this.data.filter(t=>{const e=t.id||t[0]||this.data.indexOf(t);return this.state.selected.has(e)});if(!t.length)return void this.callbacks.onError("No data selected");const e=t.map(t=>(Array.isArray(t)?t:Object.values(t)).join("\t")).join("\n");navigator.clipboard.writeText(e).then(()=>this.callbacks.onSuccess(`${t.length} rows copied`)).catch(()=>this.callbacks.onError("Copy failed"))}handleAdd(){this.callbacks.onAddClick(t=>{this.config.api?.create?this.createRow(t):(this.data.push(t),this.render(),this.callbacks.onSuccess("Data added"))})}handleEdit(t,e){this.callbacks.onEditClick(t,e,e=>{this.config.api?.update?this.updateRow(t,e):(this.data[t]=e,this.render(),this.callbacks.onSuccess("Data updated"))})}handleDelete(t,e){this.callbacks.onDeleteClick(t,e,a=>{a&&(this.config.api?.delete?this.deleteRow(t,e):(this.data.splice(t,1),this.render(),this.callbacks.onSuccess("Data deleted")))})}async loadData(){if(this.config.api?.load){this.showLoading(!0);try{const t=await fetch(this.config.api.load);if(!t.ok)throw new Error("Load failed");const e=await t.json();this.data=Array.isArray(e)?e:[],this.filtered=[...this.data],this.render(),this.callbacks.onLoad(this.data)}catch(t){this.callbacks.onError("Failed to load data: "+t.message)}finally{this.showLoading(!1)}}}async createRow(t){if(this.config.api?.create){this.showLoading(!0);try{const e=await fetch(this.config.api.create,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error("Create failed");const a=await e.json();this.data.push(a.data||t),this.render(),this.callbacks.onSuccess("Data created successfully")}catch(t){this.callbacks.onError("Failed to create: "+t.message)}finally{this.showLoading(!1)}}}async updateRow(t,e){if(!this.config.api?.update)return;const a=this.data[t],i=a.id||a[0],s=this.config.api.update.replace(":id",i);this.showLoading(!0);try{if(!(await fetch(s,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Update failed");this.data[t]=e,this.render(),this.callbacks.onSuccess("Data updated successfully")}catch(t){this.callbacks.onError("Failed to update: "+t.message)}finally{this.showLoading(!1)}}async deleteRow(t,e){if(!this.config.api?.delete)return;const a=e.id||e[0],i=this.config.api.delete.replace(":id",a);this.showLoading(!0);try{if(!(await fetch(i,{method:"DELETE"})).ok)throw new Error("Delete failed");this.data.splice(t,1),this.render(),this.callbacks.onSuccess("Data deleted successfully")}catch(t){this.callbacks.onError("Failed to delete: "+t.message)}finally{this.showLoading(!1)}}showLoading(t){this.state.loading=t,t&&!this.dom.loading?(this.dom.loading=document.createElement("div"),this.dom.loading.className="pd-loading",this.dom.loading.innerHTML='<div class="pd-spinner"></div>',this.dom.wrapper.appendChild(this.dom.loading)):!t&&this.dom.loading&&(this.dom.loading.remove(),this.dom.loading=null)}exportCSV(t="data.csv"){if(!this.filtered.length)return void this.callbacks.onError("No data to export");const e=this.filtered.map(t=>(Array.isArray(t)?t:Object.values(t)).map(t=>`"${String(t).replace(/"/g,'""')}"`).join(",")).join("\n"),a=new Blob([e],{type:"text/csv"}),i=document.createElement("a");i.href=URL.createObjectURL(a),i.download=t,i.click(),this.callbacks.onSuccess("CSV exported")}refresh(){this.config.api?.load?this.loadData():this.render()}updateData(t){this.data=Array.isArray(t)?t:[],this.filtered=[...this.data],this.render()}addRow(t){(Array.isArray(t)||"object"==typeof t)&&(this.data.push(t),this.render())}clearSelection(){this.state.selected.clear(),this.updateUI()}getSelectedData(){return this.data.filter(t=>{const e=t.id||t[0]||this.data.indexOf(t);return this.state.selected.has(e)})}destroy(){this.scrollRAF&&cancelAnimationFrame(this.scrollRAF),clearTimeout(this.state.searchTimeout),this.dom.wrapper?.parentNode&&(this.dom.wrapper.parentNode.insertBefore(this.table,this.dom.wrapper),this.dom.wrapper.remove())}}"undefined"!=typeof window&&(window.PdTables=PdTables);